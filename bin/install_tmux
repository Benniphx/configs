#!/bin/bash

set -e
set -u

### Configuration ##############################################################

tmux_version='2.4'

### Tmux #######################################################################

tmux_install_dir="$(mktemp -d)"
pushd "$tmux_install_dir" >/dev/null

# Compile libevent
wget https://github.com/downloads/libevent/libevent/libevent-2.0.21-stable.tar.gz
tar xzf libevent-2.0.21-stable.tar.gz
pushd libevent-2.0.21-stable >/dev/null
./configure --prefix="$HOME/local" --disable-shared
make
make install
popd >/dev/null

# Compile ncurses
wget ftp://ftp.gnu.org/gnu/ncurses/ncurses-6.0.tar.gz
tar xzf ncurses-6.0.tar.gz
pushd ncurses-6.0 >/dev/null
./configure CPPFLAGS='-P' --prefix="$HOME/local"
CPPFLAGS='-P' make
make install
popd >/dev/null

# Compile tmux
wget -O tmux-${tmux_version}.tar.gz https://github.com/tmux/tmux/releases/download/${tmux_version}/tmux-${tmux_version}.tar.gz
tar xzf tmux-${tmux_version}.tar.gz
pushd tmux-${tmux_version} >/dev/null
./configure CFLAGS="-I$HOME/local/include -I$HOME/local/include/ncurses" \
LDFLAGS="-L$HOME/local/lib -L$HOME/local/include/ncurses \
-L$HOME/local/include"
CPPFLAGS="-I$HOME/local/include -I$HOME/local/include/ncurses" \
LDFLAGS="-static -L$HOME/local/include -L$HOME/local/include/ncurses \
-L$HOME/local/lib" make
cp -f tmux "$HOME/local/bin"
popd >/dev/null

### Tpm ########################################################################

tpm_dir="$HOME/.tmux/plugins/tpm"
git clone https://github.com/tmux-plugins/tpm "$tpm_dir" || \
  git -C "$tpm_dir" pull --rebase origin master
