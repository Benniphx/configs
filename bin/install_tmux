#!/bin/bash

set -e
set -u

### Configuration ##############################################################

tmux_version='2.5'

### Tmux #######################################################################

tmux_install_dir="$(mktemp -d)"
pushd "$tmux_install_dir" >/dev/null

if [[ "$OSTYPE" = darwin* ]] ; then
  # Compile libevent
  curl -OL https://github.com/libevent/libevent/releases/download/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz
  tar xzf libevent-2.0.22-stable.tar.gz
  cd libevent-2.0.22-stable
  LDFLAGS="-L/usr/local/opt/openssl/lib" CPPFLAGS="-I/usr/local/opt/openssl/include" \
    ./configure --prefix="$HOME/local"
  make clean
  make
  make install

  # Compile tmux
  cd ..
  curl -OL https://github.com/tmux/tmux/releases/download/${tmux_version}/tmux-${tmux_version}.tar.gz
  tar xzf tmux-${tmux_version}.tar.gz
  cd tmux-${tmux_version}
  LDFLAGS="-L/opt/lib" CPPFLAGS="-I/opt/include" LIBS="-lresolv" \
    ./configure --prefix="$HOME/local"
  make clean
  make
  make install
fi

### Tpm ########################################################################

tpm_dir="$HOME/.tmux/plugins/tpm"
git clone https://github.com/tmux-plugins/tpm "$tpm_dir" || \
  git -C "$tpm_dir" pull --rebase origin master
